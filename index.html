<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inicio de Sesión</title>

    <script async src="https://js.onclckmn.com/static/onclicka.js" data-admpid="248887"></script>

    <style>
 body {
            font-family: Arial, sans-serif;
            background-color: #1a1818;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            width: max-content;
            text-align: center;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Establece un tamaño máximo para las imágenes */
#registerForm img {
    max-width: 100px; /* Cambia este valor según el tamaño que desees */
    max-height: 100px; /* Cambia este valor según el tamaño que desees */
    width: auto; /* Para que mantenga la proporción */
    height: auto; /* Para que mantenga la proporción */
    object-fit: cover; /* Para asegurarse de que la imagen se ajuste bien */
}


        input, select, textarea, button {
            width: 100%;
            padding: 10px;
            margin-top: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 16px;
            font-family: Arial, sans-serif;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #00ff77;
            box-shadow: 0 0 6px rgba(0, 255, 119, 0.5);
        }

   

        label {
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }
 
        /* buttton green normal*/

        button {
            background-color: #07991a;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #0c770c;
        }

    /* buttton green normal*/
    .bttngreen2 {
        background-color: #016a32;
           
    }


     /* buttton coffe */


     .bttnCoffe {
        background-color:rgb(128, 57, 27);


     }

        /* Estilo para el select */
        select {
            appearance: none;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
   

          /* Mensajes de error o validación */
          input:invalid {
            border-color: rgb(192, 102, 0);
            box-shadow: 0 0 7px rgb(192, 102, 0);

        }


        .hidden {
            display: none;
        }

        .status-pendiente {
            color: orange;
        }

        .status-aprobado {
            color: green;
        }

        .status-cancelado {
            color: red;
        }

        .status-buttons {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .approved-list {
            margin-top: 10px;
            text-align: left;
        }

        .total-approved {
            margin-top: 10px;
            font-size: 1.2em;
            font-weight: bold;
        }

        .preview {
            margin-top: 10px;
            max-width: 100%;
            height: auto;
        }

        .photo-container {
            margin-bottom: 20px;
        }


        #gender {
    display: flex;
    gap: 1em; /* Espacio entre los radios */
}



#gender label {
    display: flex;

    font-size: .9em;
    color: #000;
    align-items: center; /* Alinear el texto y el radio verticalmente */
    cursor: pointer; /* Cambiar cursor al pasar sobre el label */
}

#gender input[type="radio"] {
    accent-color: #00ff77; /* Cambia el color de los radios a verde */
    margin-right: 1px

}


        
       /* Estilo para el contenedor de referencias */
#contenedor-referencias {
    border: 1px solid #ccc; /* Opcional: agrega un borde para ver el contenedor claramente */
    padding: 10px;
    width: 100%; /* Ajusta el ancho según lo necesites */
    box-sizing: border-box; /* Asegura que el padding y el borde no afecten el tamaño total */
}

/* Estilo para cada referencia */
.referencia {
    margin-bottom: 10px;  /* Espacio entre cada referencia */
    padding: 10px;
    border: 1px solid #ddd; /* Opcional: agrega un borde para separar visualmente cada referencia */
    border-radius: 4px; /* Opcional: bordes redondeados */
    background-color: #f9f9f9; /* Opcional: color de fondo */
}

/* Estilo para los campos de entrada y el botón dentro de cada referencia */
.referencia input,
.referencia button {
    display: block;
    width: calc(100% - 20px); /* Ajusta el ancho con un margen para el padding */
    margin-bottom: 10px; /* Espacio entre los campos y el botón */
    padding: 8px;
    box-sizing: border-box; /* Asegura que el padding no afecte el ancho total */
}

.referencia button {
    width: auto; /* Ajusta el ancho del botón */
}


/* Estilos para el nombre de la referencia */
.referencia .nombre {
    /* Peso de la fuente */
    font-weight: bold;
}

/* Estilos para el teléfono de la referencia */
.referencia .telefono {
    /* Color de texto */
    color: #666;
}

/* Estilo para pataamo de previzualizacion de imagenes id y selfie */
.preview {
    width: 20%;
    height: auto;
}

h2 {
    font-size: .8em;
}

h1 {
    color: #109e10;
}



    </style>
</head>
<body>
    
    <div class="container">
        <!-- Formulario de Inicio de Sesión -->
        <div id="loginFormContainer">
            <h1>AvoCoin</h1>
            <h2 id="">Préstamos express</h2>
            <h3>Inicio de Sesión</h3>
            <form id="loginForm">
                <input type="tel" id="phone" placeholder="Número de Teléfono" required>
                <input type="password" id="password" placeholder="Contraseña" required>
                <button type="submit" id="btnSubmit">Iniciar sesión</button>
            </form>
            <button id="showRegisterForm">Nuevo Usuario</button>
        </div>

        <!-- Perfil del Usuario -->
        <div id="profileContainer" class="hidden">
            <h2>Perfil del Usuario</h2>
<div id="totalsContainer">
    <p><span id="totalApprovedAmount"></span></p>
    <p>Pago Pendiente: <span id="approvedTotalPerTerm"></span></p>
</div>
            <p><strong>Hola!</strong> <span id="profileName"></span></p>
            <p><strong>Teléfono:</strong> <span id="profilePhone"></span></p>

            <div id="pendingRequestMessage" style="display: none; color: red;">
                Solicitud de préstamo pendiente.
            </div>
          
            <button id="requestLoanBtn">Solicitar Préstamo</button>

            <!-- solicitud cantidad de $$ -->
            <div id="loanRequestFormContainer" class="hidden">
                <label for="loanAmount">Cantidad:</label>
                <input type="text" id="loanAmount" value="500.00" placeholder="$0.00">
                <p id="loanRequestStatus"></p>
                <label for="termAmount">Plazos</label>
                <select id="termAmount">
                    <option value="1">1 plazo semanal</option>
                    <option value="2">2 plazos semanales</option>
                    <option value="3">3 plazos semanales</option>
                    <option value="4">4 plazos semanales</option>
                    <option value="5">5 plazos semanales</option>
                    <option value="6">6 plazos semanales</option>
                    <option value="7">7 plazos semanales</option>
                    <option value="8">8 plazos semanales</option>
                    <option value="9">9 plazos semanales</option>
                    <option value="10">10 plazos semanales</option>
                    <option value="11">11 plazos semanales</option>
                    <option value="12">12 plazos semanales</option>
                </select>

                <button id="submitLoanRequest">Enviar Solicitud</button>
            </div>

            <!-- Botón para mostrar/ocultar solicitudes -->
<button id="toggleRequestsButton">Mostrar solicitudes</button>

<!-- Div con solicitudes inicialmente oculto -->
<div id="RequestsDiv" style="display: none;">
    <h3>Préstamos Aprobados</h3>
    <ul id="approvedRequestsList" class="approved-list"></ul>
    <h3>Solicitudes Pendientes</h3>
    <ul id="loanRequestsList"></ul>
</div>

            <!-- Botón para mostrar/ocultar información personal -->
<button id="toggleInfoButton">Mostrar información personal</button>

<!-- Div con información personal inicialmente oculto -->
<div id="personalInfo" style="display: none;">
    <p><strong>Dirección IP:</strong> <span id="profileIp"></span></p>
    <p><strong>Ubicación:</strong> <span id="profileLocation"></span></p>
    <p><strong>Última Hora de Sesión:</strong> <span id="profileLastLogin"></span></p>
    <p><strong>Contraseña:</strong> <span id="profilePassword"></span></p>
    <p>Si no reconoces estos datos contactate con nuestro equipo.</p>
</div>
        

        <button id="logoutBtn" class="bttnCoffe" >Cerrar Sesión</button>

    </div>
            
        </div>
   


     <!-- Formulario de Registro -->
     <div id="registerFormContainer" class="hidden">
        <h3>Registrar Nuevo Usuario</h3>
        <form id="registerForm">
            <input type="text" id="regName" placeholder="Nombre" required>
            <input type="tel" id="regPhone" placeholder="Número de Teléfono" required>
            <input type="email" id="email" placeholder="Correo Electrónico @" norequired>
            <input type="password" id="regPassword" placeholder="Contraseña ***" required>
            <input type="password" id="confirmPassword" placeholder="Confirmar Contraseña ***" required>



            <div id="gender">
            <label for="gender">Selecciona tu género:</label>
            <input type="radio" id="hombre" name="gender" value="hombre">
            <label for="hombre">Hombre</label>
            <input type="radio" id="mujer" name="gender" value="mujer">
            <label for="mujer">Mujer</label>
            </div>

            <input type="number" id="age" placeholder="Edad" min="18" max="99" norequired>
            <input tpe="text" id="curp" placeholder="Curp">
            <input type="text" id="address" placeholder="Domicilio Calle y #" no required>
            <input type="text" id="cp" placeholder="Código Postal">
            <input type="text" id="city" placeholder="Localidad o Ciudad">

            <label for="study">Grado de Estudio</label>
            <select id="study">
            <option value="Primaria">Primaria</option>
            <option value="Secundaria">Secundaria</option>
            <option value="Preparatoria">Preparatoria</option>
            <option value="Univerdiad">Univerdiad</option>
            <option value="Maestria">Maestria</option>
            <option value="Doctorado">Doctorado</option>
            </select>

            <input type="tex" id="work" placeholder="Trabajo">
            <input type="number" id="worktime" placeholder="Tiempo en el trabajo en meses">
       
            
                <label for="tipeBanck">Número de cuenta o tarjeta bancaria al que depositaremos el dinero</label>
                <select id="tipeBanck">
                <option value="Tarjeta débito">Tarjeta débito</option>
                <option value="Tarjeta crédito">Tarjeta crédito</option>
                <option value="Número de cuenta bancaria">Número de cuenta bancaria</option>
                </select>

                <input type="text" id="bankAcount" placeholder="Número de Tarjeta o Cuenta bancaria" maxlength="12">
                
            
            <!-- Sección para fotos del ID -->
            <div class="photo-container">
                <h3>Identificación Oficial INE</h3>
                <label for="frontPhoto">Foto del Frente del INE:</label>
                <input type="file" id="frontPhoto"   accept="image/*" capture="environment"><br>
                <div id="frontPreview">
                    <img id="frontImagePreview" class="preview" src="" alt="Vista previa del frente del INE">
                </div>
                <label for="backPhoto">Foto del Reverso del INE:</label>
                <input type="file" id="backPhoto" accept="image/*" capture="environment"><br>
                <div id="backPreview">
                    <img id="backImagePreview" class="preview" src="" alt="Vista previa del reverso del INE">
                </div>
            </div>

            <div class="photo-container">
                <label for="selfie">Reconocimiento facial</label>
                <input type="file" id="selfie" accept="image/*" capture="user"><br>
                <div id="selfiePreview">
                    <img id="selfieImagePreview" class="preview" src="" alt="Reconocimiento facial">
                </div>
            </div>


            <h5>Referencias</h5>

            <!-- Contenedor de referencias -->
            <div id="reference1">
                <input type="text" id="" class="nameReferance" placeholder="Nombre Referencia 1">
                <input type="text" id="" class="telReferance" placeholder="Telefono Referencia 1">
                <input type="text" id="" class="RelatReferance" placeholder="Parenteso Referencia 1">
            </div>

            <div id="reference2">
                <input type="text" id="" class="nameReferance" placeholder="Nombre Referencia 2">
                <input type="text" id="" class="telReferance" placeholder="Telefono Referencia 2">
                <input type="text" id="" class="RelatReferance" placeholder="Parenteso Referencia 2">
            </div>

            <div id="reference3">
                <input type="text" id="" class="nameReferance" placeholder="Nombre Referencia 3">
                <input type="text" id="" class="telReferance" placeholder="Telefono Referencia 3">
                <input type="text" id="" class="RelatReferance" placeholder="Parenteso Referencia 3">
            </div>

            <div id="reference4">
                <input type="text" id="" class="nameReferance" placeholder="Nombre Referencia 4">
                <input type="text" id="" class="telReferance" placeholder="Telefono Referencia 4">
                <input type="text" id="" class="RelatReferance" placeholder="Parenteso Referencia 4">
            </div>


            <div id="reference5" class="hidden">
                <input type="text" id="" class="nameReferance" placeholder="Nombre Referencia 5">
                <input type="text" id="" class="telReferance" placeholder="Telefono Referencia 5">
                <input type="text" id="" class="RelatReferance" placeholder="Parenteso Referencia 5">
            </div>

            <div id="reference6" class="hidden">
                <input type="text" id="" class="nameReferance" placeholder="Nombre Referencia 6">
                <input type="text" id="" class="telReferance" placeholder="Telefono Referencia 6">
                <input type="text" id="" class="RelatReferance" placeholder="Parenteso Referencia 6">
            </div>

            <div id="reference7" class="hidden">
                <input type="text" id="" class="nameReferance" placeholder="Nombre Referencia 7">
                <input type="text" id="" class="telReferance" placeholder="Telefono Referencia 7">
                <input type="text" id="" class="RelatReferance" placeholder="Parenteso Referencia 7">
            </div>

            <div id="reference8" class="hidden">
                <input type="text" id="" class="nameReferance" placeholder="Nombre Referencia 8">
                <input type="text" id="" class="telReferance" placeholder="Telefono Referencia 8">
                <input type="text" id="" class="RelatReferance" placeholder="Parenteso Referencia 8">
            </div>

            <div id="reference9" class="hidden">
                <input type="text" id="" class="nameReferance" placeholder="Nombre Referencia 9">
                <input type="text" id="" class="telReferance" placeholder="Telefono Referencia 9">
                <input type="text" id="" class="RelatReferance" placeholder="Parenteso Referencia 9">
            </div>

            <div id="reference10" class="hidden">
                <input type="text" id="" class="nameReferance" placeholder="Nombre Referencia 10">
                <input type="text" id="" class="telReferance" placeholder="Telefono Referencia 10">
                <input type="text" id="" class="RelatReferance" placeholder="Parenteso Referencia 10">
            </div>




              <!-- Botón para agregar referencia -->
              <button type="button" id="agregar-referencia" class="bttngreen2">Agrega referencia</button>


              <button type="submit" id="registerBtn">Registrar</button>
        </form>

        <button id="backToLogin" class="bttnCoffe">Volver al Inicio de Sesión</button>
    </div>
</div>

    <script>
        const button = document.getElementById('agregar-referencia');
        let referenceIndex = 5; // Comenzar desde 5, ya que los primeros 4 están visibles

        button.addEventListener('click', () => {
            const referenceDiv = document.getElementById(`reference${referenceIndex}`);
            if (referenceDiv) {
                referenceDiv.classList.remove('hidden');
                referenceIndex++;
            } else {
                alert('No hay más referencias para agregar.');
            }
        });
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getDatabase, ref, set, get, push, onValue, update } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCTGTslJDeB8shPTz2EUW6xnpgIKMSkplE",
            authDomain: "avocoin-c672b.firebaseapp.com",
            databaseURL: "https://avocoin-c672b-default-rtdb.firebaseio.com",
            projectId: "avocoin-c672b",
            storageBucket: "avocoin-c672b.appspot.com",
            messagingSenderId: "735532990633",
            appId: "1:735532990633:web:5c3e906b84e48936fbe9b8",
            measurementId: "G-Q0TJQC1RE7"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const storage = getStorage(app);




// Manejo de inicio de sesión
document.getElementById('loginForm').addEventListener('submit', async (event) => {
    event.preventDefault();
    const phone = document.getElementById('phone').value;
    const password = document.getElementById('password').value;

    // Verificar credenciales
    const userRef = ref(database, 'users/' + phone);
    const snapshot = await get(userRef);

    if (snapshot.exists() && snapshot.val().password === password) {
        // Autenticación exitosa
        document.getElementById('loginFormContainer').classList.add('hidden');
        document.getElementById('profileContainer').classList.remove('hidden');

        // Mostrar información del perfil
        document.getElementById('profileName').textContent = snapshot.val().name;
        document.getElementById('profilePhone').textContent = phone;
        document.getElementById('profilePassword').textContent = password; 


         // Cargar solicitudes y mostrar totales
         loadRequests(phone); // Cargar solicitudes al iniciar sesión



         // Cargar la última cantidad y plazo
        const lastLoanAmount = snapshot.val().lastLoanAmount || '';
        const lastLoanTerm = snapshot.val().lastLoanTerm || '';

        loanAmountInput.value = lastLoanAmount; // Mostrar la última cantidad
        termAmountInput.value = lastLoanTerm; // Mostrar el último plazo


        // Obtener IP y ubicación
        const ip = await getUserIp();
        document.getElementById('profileIp').textContent = ip;

        const location = await getUserLocation();
        document.getElementById('profileLocation').textContent = location;

        // Registrar la última hora de sesión, la IP y la localización
        const lastLogin = new Date().toISOString();
        await update(userRef, { lastLogin, ip, location });  // Guardar IP y localización en la base de datos

        document.getElementById('profileLastLogin').textContent = lastLogin;

    } else {
        alert('Número de teléfono o contraseña incorrectos.');
    }
});

// Función para obtener la IP del usuario
async function getUserIp() {
    try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip;
    } catch (error) {
        console.error('Error al obtener la IP:', error);
        return 'IP no disponible';
    }
}

// Función para obtener la ubicación del usuario
function getUserLocation() {
    if (navigator.geolocation) {
        return new Promise((resolve) => {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    resolve(`Latitud: ${latitude}, Longitud: ${longitude}`);
                },
                (error) => {
                    console.error('Error al obtener la ubicación:', error);
                    resolve('Ubicación no disponible');
                }
            );
        });
    } else {
        return Promise.resolve('Geolocalización no soportada');
    }
}




        // Mostrar formulario de registro y ocultar formulario de inicio de sesión
        document.getElementById('showRegisterForm').addEventListener('click', () => {
            document.getElementById('loginFormContainer').classList.add('hidden');
            document.getElementById('registerFormContainer').classList.remove('hidden');
        });





        // Manejar vista previa de imágenes
        function handleFileSelect(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById(event.target.dataset.previewId);
                preview.src = e.target.result;
                preview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        document.getElementById('frontPhoto').addEventListener('change', (event) => handleFileSelect({ target: { files: event.target.files, dataset: { previewId: 'frontImagePreview' } } }));
        document.getElementById('backPhoto').addEventListener('change', (event) => handleFileSelect({ target: { files: event.target.files, dataset: { previewId: 'backImagePreview' } } }));
        document.getElementById('selfie').addEventListener('change', (event) => handleFileSelect({ target: { files: event.target.files, dataset: { previewId: 'selfieImagePreview' } } }));

        




// Manejo del registro de usuario
document.getElementById('registerForm').addEventListener('submit', async (event) => {
    event.preventDefault(); // Prevenir envío del formulario

    const name = document.getElementById('regName').value;
    const phone = document.getElementById('regPhone').value;
    const email = document.getElementById('email').value;
    const password = document.getElementById('regPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const age = document.getElementById('age').value;
    const curp = document.getElementById('curp').value;
    const address = document.getElementById('address').value;
    const cp = document.getElementById('cp').value;
    const city = document.getElementById('city').value;
    const study = document.querySelector('#study').value;
    const work = document.getElementById('work').value;
    const worktime = document.getElementById('worktime').value;
    const selectedBankOption = document.querySelector('#tipeBanck').value;
    const bankAcount = document.getElementById('bankAcount').value;

    const registrationDate = new Date().toISOString();

    // Verificar que todos los campos requeridos estén llenos
    if (!name || !phone || !password) {
        alert('Por favor, completa todos los campos.');
        return;
    }

    // Verificar que las contraseñas coincidan
    if (password !== confirmPassword) {
        alert('Las contraseñas no coinciden.');
        return; // Salir de la función si las contraseñas no coinciden
    }

    const userRef = ref(database, 'users/' + phone);
    
    try {
        const snapshot = await get(userRef);
        if (snapshot.exists()) {
            alert('El usuario con este número de teléfono ya está registrado.'); // Mensaje al usuario
            return; // Salir si el usuario ya existe
        }

        // Subir fotos
        const frontPhoto = document.getElementById('frontPhoto').files[0];
        const backPhoto = document.getElementById('backPhoto').files[0];
        const selfie = document.getElementById('selfie').files[0];

        if (frontPhoto && backPhoto && selfie) {
            // Subir fotos a Firebase Storage y obtener URLs
            const frontPhotoRef = storageRef(storage, `users/${phone}/frontPhoto`);
            const backPhotoRef = storageRef(storage, `users/${phone}/backPhoto`);
            const selfieRef = storageRef(storage, `users/${phone}/selfie`);

            await uploadBytes(frontPhotoRef, frontPhoto);
            await uploadBytes(backPhotoRef, backPhoto);
            await uploadBytes(selfieRef, selfie);

            const frontPhotoURL = await getDownloadURL(frontPhotoRef);
            const backPhotoURL = await getDownloadURL(backPhotoRef);
            const selfieURL = await getDownloadURL(selfieRef);

            // Guardar datos del usuario en la base de datos
            await set(userRef, {
                name,
                phone,
                email,
                password,
                age,
                curp,
                address,
                cp,
                city,
                study,
                work,
                worktime,
                tipeBanck: selectedBankOption,
                bankAcount,
                frontPhoto: frontPhotoURL,
                backPhoto: backPhotoURL,
                selfie: selfieURL,
                registrationDate: registrationDate
            });

            alert('Usuario registrado exitosamente.');

            // Recargar la página después de que el usuario se registre
            window.location.reload();
        } else {
            alert('Por favor, sube todas las fotos requeridas.');
        }
    } catch (error) {
        console.error('Error al registrar el usuario:', error);
        alert('Error al registrar el usuario. Inténtalo de nuevo.');
    }
});

        
        // Volver al formulario de inicio de sesión
        document.getElementById('backToLogin').addEventListener('click', () => {
            document.getElementById('registerFormContainer').classList.add('hidden');
            document.getElementById('loginFormContainer').classList.remove('hidden');
        });





// Función para cargar solicitudes y aprobaciones
function loadRequests(phone) {
    const loanRequestsRef = ref(database, 'users/' + phone + '/loanRequests');
    onValue(loanRequestsRef, (snapshot) => {
        const requestsList = document.getElementById('loanRequestsList');
        const approvedRequestsList = document.getElementById('approvedRequestsList');
        const pendingRequestMessage = document.getElementById('pendingRequestMessage'); // Mensaje de solicitud pendiente
        let totalApproved = 0;
        let hasPendingRequest = false; // Variable para verificar si hay una solicitud pendiente

        requestsList.innerHTML = '';
        approvedRequestsList.innerHTML = '';

        snapshot.forEach((childSnapshot) => {
            const request = childSnapshot.val();
            const status = request.status || 'pendiente';
            const amount = request.amount;
            const term = request.term;

            // Verificar si hay una solicitud pendiente
            if (status === 'pendiente') {
                hasPendingRequest = true;
            }

            // Agregar a la lista de solicitudes
            const li = document.createElement('li');
            li.className = getStatusClass(status);
            li.innerHTML = `
                Monto: ${amount} (Solicitado el ${new Date(request.timestamp).toLocaleString()}) - Estado: ${getStatusText(status)}
                <div class="status-buttons">
                    
                </div>
            `;
            requestsList.appendChild(li);

            if (status === 'aceptado') {
                const approvedLi = document.createElement('li');
                approvedLi.className = 'status-aprobado';
                approvedLi.textContent = `Monto Aprobado: ${amount} (Solicitado el ${new Date(request.timestamp).toLocaleString()}), Plazo: ${term} meses`;
                approvedRequestsList.appendChild(approvedLi);

                // Sumar al total aprobado
                totalApproved += amount;
            }
        });

        // Mostrar o ocultar el mensaje de solicitud pendiente
        if (hasPendingRequest) {
            pendingRequestMessage.style.display = 'block'; // Mostrar mensaje si hay solicitud pendiente
        } else {
            pendingRequestMessage.style.display = 'none'; // Ocultar mensaje si no hay solicitudes pendientes
        }

        // Calcular y mostrar totales
        calculateTotals(totalApproved);
    });
}


// Función para calcular y mostrar totales
function calculateTotals(totalApproved) {
    const totalApprovedAmount = document.getElementById('totalApprovedAmount');
    const approvedTotalPerTerm = document.getElementById('approvedTotalPerTerm');

    // Actualizar el total aprobado
    totalApprovedAmount.textContent = `$${totalApproved.toFixed(2)}`;

    // Calcular y mostrar el monto por plazo
    const selectedTerm = document.getElementById('termAmount').value || 1; // Asume 1 si no hay plazo
    const totalPerTerm = totalApproved / selectedTerm;
    approvedTotalPerTerm.textContent = `$${totalPerTerm.toFixed(2)} por plazo`;
}




// Llamar a loadRequests cuando la aplicación se inicia
document.addEventListener('DOMContentLoaded', () => {
    const userPhone = userPhoneElement.textContent; // Obtener el número de teléfono del usuario
    loadRequests(userPhone); // Cargar solicitudes al iniciar
});





// Función para actualizar el estado de una solicitud
window.updateRequestStatus = (phone, requestId, status) => {
    const requestRef = ref(database, 'users/' + phone + '/loanRequests/' + requestId);
    update(requestRef, { status })
        .then(() => {
            alert(`Préstamo ${status === 'aceptado' ? 'aceptado' : 'cancelado'} exitosamente.`);
            loadRequests(phone);
        })
        .catch((error) => {
            alert('Error al actualizar el estado: ' + error.message);
        });
};

function getStatusClass(status) {
    if (status === 'aceptado') {
        return 'status-aprobado';
    } else if (status === 'cancelado') {
        return 'status-cancelado';
    }
    return 'status-pendiente';
}

function getStatusText(status) {
    if (status === 'aceptado') {
        return 'Aprobado';
    } else if (status === 'cancelado') {
        return 'Cancelado';
    }
    return 'Pendiente';
}



// Solicitar un préstamo
document.getElementById('requestLoanBtn').addEventListener('click', () => {
    document.getElementById('loanRequestFormContainer').classList.remove('hidden');
});

// Obtener elementos del DOM
const submitLoanRequestButton = document.getElementById('submitLoanRequest');
const loanAmountInput = document.getElementById('loanAmount');
const termAmountInput = document.getElementById('termAmount');
const userPhoneElement = document.getElementById('profilePhone');
const loanRequestStatusElement = document.getElementById('loanRequestStatus');

// Función para validar cantidad de préstamo
function validateLoanAmount(amount) {
    return !isNaN(amount) && amount > 0;
}

// Función para crear referencia a la base de datos
function createLoanRequestRef(userPhone) {
    return ref(database, 'users/' + userPhone + '/loanRequests/' + Date.now());
}

// Función para enviar solicitud de préstamo
function sendLoanRequest(loanAmount, termAmount, userPhone) {
    const loanRequestRef = createLoanRequestRef(userPhone);

    // Verificar si hay solicitudes pendientes o aprobadas
    const loanRequestsRef = ref(database, 'users/' + userPhone + '/loanRequests');
    get(loanRequestsRef).then((snapshot) => {
        let hasPendingOrApproved = false;

        snapshot.forEach((childSnapshot) => {
            const request = childSnapshot.val();
            const status = request.status;

            if (status === 'pendiente' || status === 'aceptado') {
                hasPendingOrApproved = true;
            }
        });

        if (hasPendingOrApproved) {
            alert('No puedes enviar una nueva solicitud mientras hay solicitudes pendientes o aprobadas.');
            return; // Salir si hay solicitudes pendientes o aprobadas
        }

        // Si no hay solicitudes pendientes, proceder a guardar la nueva solicitud
        set(loanRequestRef, {
            amount: loanAmount,
            timestamp: new Date().toISOString(),
            status: 'pendiente',
            term: termAmount
        })
        .then(() => {
            // Guardar la última cantidad y plazo en el perfil del usuario
            const userRef = ref(database, 'users/' + userPhone);
            update(userRef, {
                lastLoanAmount: loanAmount,
                lastLoanTerm: termAmount
            });

            showSuccessMessage();
            clearLoanAmountInput();
            loadRequests(userPhone);
        })
        .catch((error) => {
            showErrorMessage(error.message);
        });
    }).catch((error) => {
        alert('Error al verificar solicitudes: ' + error.message);
    });
}


// Agregar evento click al botón de enviar solicitud
submitLoanRequestButton.addEventListener('click', (e) => {
    e.preventDefault();
    const loanAmount = parseFloat(loanAmountInput.value);
    const termAmount = termAmountInput.value;
    const userPhone = userPhoneElement.textContent;

    if (validateLoanAmount(loanAmount)) {
        sendLoanRequest(loanAmount, termAmount, userPhone);
    } else {
        alert('Por favor, ingrese una cantidad válida.');
    }
});


// Obtener elementos del DOM
const toggleRequestsButton = document.getElementById('toggleRequestsButton');
const requestsDiv = document.getElementById('RequestsDiv');

// Función para toggle visibilidad del div
function toggleRequestsVisibility() {
    if (requestsDiv.style.display === 'none') {
        requestsDiv.style.display = 'block';
        toggleRequestsButton.textContent = 'Ocultar solicitudes';
    } else {
        requestsDiv.style.display = 'none';
        toggleRequestsButton.textContent = 'Mostrar solicitudes';
    }
}

// Agregar evento click al botón
toggleRequestsButton.addEventListener('click', toggleRequestsVisibility);

// Obtener elementos del DOM
const toggleInfoButton = document.getElementById('toggleInfoButton');
const personalInfoDiv = document.getElementById('personalInfo');

// Función para toggle visibilidad del div
function toggleInfoVisibility() {
    if (personalInfoDiv.style.display === 'none') {
        personalInfoDiv.style.display = 'block';
        toggleInfoButton.textContent = 'Ocultar información personal';
    } else {
        personalInfoDiv.style.display = 'none';
        toggleInfoButton.textContent = 'Mostrar información personal';
    }
}

// Agregar evento click al botón
toggleInfoButton.addEventListener('click', toggleInfoVisibility);



        // Cierre de sesión
        document.getElementById('logoutBtn').addEventListener('click', () => {
            document.getElementById('profileContainer').classList.add('hidden');
            document.getElementById('loginFormContainer').classList.remove('hidden');
        });



    </script>
</body>
</html>
