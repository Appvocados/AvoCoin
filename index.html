<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inicio de Sesión</title>
    <style>
 body {
            font-family: Arial, sans-serif;
            background-color: #1a1818;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            width: max-content;
            text-align: center;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Establece un tamaño máximo para las imágenes */
#registerForm img {
    max-width: 100px; /* Cambia este valor según el tamaño que desees */
    max-height: 100px; /* Cambia este valor según el tamaño que desees */
    width: auto; /* Para que mantenga la proporción */
    height: auto; /* Para que mantenga la proporción */
    object-fit: cover; /* Para asegurarse de que la imagen se ajuste bien */
}


        input, select, textarea, button {
            width: 100%;
            padding: 10px;
            margin-top: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 16px;
            font-family: Arial, sans-serif;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #00ff77;
            box-shadow: 0 0 5px rgba(0, 255, 119, 0.5);
        }

   

        label {
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }

        button {
            background-color: #00ff77;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #0c770c;
        }

        /* Estilo para el select */
        select {
            appearance: none;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            background-color: #00ff77;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #0c770c;
        }

          /* Mensajes de error o validación */
          input:invalid {
            border-color: rgb(192, 102, 0);
        }


        .hidden {
            display: none;
        }

        .status-pendiente {
            color: orange;
        }

        .status-aprobado {
            color: green;
        }

        .status-cancelado {
            color: red;
        }

        .status-buttons {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .approved-list {
            margin-top: 10px;
            text-align: left;
        }

        .total-approved {
            margin-top: 10px;
            font-size: 1.2em;
            font-weight: bold;
        }

        .preview {
            margin-top: 10px;
            max-width: 100%;
            height: auto;
        }

        .photo-container {
            margin-bottom: 20px;
        }


        #gender {
    display: flex;
    gap: 1em; /* Espacio entre los radios */
}



#gender label {
    display: flex;

    font-size: .9em;
    color: #000;
    align-items: center; /* Alinear el texto y el radio verticalmente */
    cursor: pointer; /* Cambiar cursor al pasar sobre el label */
}

#gender input[type="radio"] {
    accent-color: #00ff77; /* Cambia el color de los radios a verde */
    margin-right: 1px

}


        
       /* Estilo para el contenedor de referencias */
#contenedor-referencias {
    border: 1px solid #ccc; /* Opcional: agrega un borde para ver el contenedor claramente */
    padding: 10px;
    width: 100%; /* Ajusta el ancho según lo necesites */
    box-sizing: border-box; /* Asegura que el padding y el borde no afecten el tamaño total */
}

/* Estilo para cada referencia */
.referencia {
    margin-bottom: 10px;  /* Espacio entre cada referencia */
    padding: 10px;
    border: 1px solid #ddd; /* Opcional: agrega un borde para separar visualmente cada referencia */
    border-radius: 4px; /* Opcional: bordes redondeados */
    background-color: #f9f9f9; /* Opcional: color de fondo */
}

/* Estilo para los campos de entrada y el botón dentro de cada referencia */
.referencia input,
.referencia button {
    display: block;
    width: calc(100% - 20px); /* Ajusta el ancho con un margen para el padding */
    margin-bottom: 10px; /* Espacio entre los campos y el botón */
    padding: 8px;
    box-sizing: border-box; /* Asegura que el padding no afecte el ancho total */
}

.referencia button {
    width: auto; /* Ajusta el ancho del botón */
}


/* Estilos para el nombre de la referencia */
.referencia .nombre {
    /* Peso de la fuente */
    font-weight: bold;
}

/* Estilos para el teléfono de la referencia */
.referencia .telefono {
    /* Color de texto */
    color: #666;
}

/* Estilo para pataamo de previzualizacion de imagenes id y selfie */
.preview {
    width: 20%;
    height: auto;
}

h2 {
    font-size: .8em;
}

h1 {
    color: #109e10;
}

    </style>
</head>
<body>
    <div class="container">
        <!-- Formulario de Inicio de Sesión -->
        <div id="loginFormContainer">
            <h1>AvoCoin</h1>
            <h2 id="">Préstamos express</h2>
            <h3>Inicio de Sesión</h3>
            <form id="loginForm">
                <input type="tel" id="phone" placeholder="Número de Teléfono" required>
                <input type="password" id="password" placeholder="Contraseña" required>
                <button type="submit" id="btnSubmit">Iniciar sesión</button>
            </form>
            <button id="showRegisterForm">Nuevo Usuario</button>
        </div>

        <!-- Formulario de Registro -->
        <div id="registerFormContainer" class="hidden">
            <h2>Registrar Nuevo Usuario</h2>
            <form id="registerForm">
                <input type="text" id="regName" placeholder="Nombre" required>
                <input type="tel" id="regPhone" placeholder="Número de Teléfono" required>
                <input type="email" id="email" placeholder="Correo Electrónico" norequired>
                <input type="password" id="regPassword" placeholder="Contraseña" required>
                <input type="password" id="confirmPassword" placeholder="Confirmar Contraseña" required>



                <div id="gender">
                <label for="gender">Selecciona tu género:</label>
                <input type="radio" id="hombre" name="gender" value="hombre">
                <label for="hombre">Hombre</label>
                <input type="radio" id="mujer" name="gender" value="mujer">
                <label for="mujer">Mujer</label>
                </div>

                <input type="number" id="age" placeholder="Edad" min="18" max="99" norequired>
                <input tpe="text" id="curp" placeholder="Curp">
                <input type="text" id="address" placeholder="Domicilio Calle y #" no required>
                <input type="text" id="cp" placeholder="Código Postal">
                <input type="text" id="city" placeholder="Localidad o Ciudad">

                <label for="dropdown">Grado de Estudio</label>
                <select id="dropdown">
                <option value="option1">Primaria</option>
                <option value="option2">Secundaria</option>
                <option value="option3">Preparatoria</option>
                <option value="option4">Univerdiad</option>
                <option value="option5">Maestria</option>
                <option value="option6">Doctorado</option>
                </select>

                <input type="tex" id="work" placeholder="Trabajo">
                <input type="number" id="worktime" placeholder="Tiempo en el trabajo en meses">
           
            

                <h2>Subir Fotos y Selfie</h2>
                
                <!-- Sección para fotos del ID -->
                <div class="photo-container">
                    <h3>Fotos del ID</h3>
                    <label for="frontPhoto">Foto del Frente del ID:</label>
                    <input type="file" id="frontPhoto"   accept="image/*" capture="environment"><br>
                    <div id="frontPreview">
                        <h4>Vista previa del Frente del ID</h4>
                        <img id="frontImagePreview" class="preview" src="" alt="Vista previa del frente del ID">
                    </div>
                    <label for="backPhoto">Foto del Reverso del ID:</label>
                    <input type="file" id="backPhoto" accept="image/*" capture="environment"><br>
                    <div id="backPreview">
                        <h4>Vista previa del Reverso del ID</h4>
                        <img id="backImagePreview" class="preview" src="" alt="Vista previa del reverso del ID">
                    </div>
                </div>

                <div class="photo-container">
                    <h3>Selfie</h3>
                    <label for="selfie">Tomar Selfie:</label>
                    <input type="file" id="selfie" accept="image/*" capture="user"><br>
                    <div id="selfiePreview">
                        <h4>Vista previa de la Selfie</h4>
                        <img id="selfieImagePreview" class="preview" src="" alt="Vista previa de la selfie">
                    </div>
                </div>


                <h5>Agregar Referencia</h5>

<!-- Contenedor de referencias -->
<div id="contenedor-referencias"></div>

<!-- Botón para agregar referencia -->
<button type="button" id="agregar-referencia">Agregar referencia</button>



                <button type="submit" id="registerBtn">Registrar</button>
            </form>
            <button id="backToLogin">Volver al Inicio de Sesión</button>
        </div>

        <!-- Perfil del Usuario -->
        <div id="profileContainer" class="hidden">
            <h2>Perfil del Usuario</h2>
            <p>$</p>
            <p><strong>Hola!</strong> <span id="profileName"></span></p>
            <p><strong>Teléfono:</strong> <span id="profilePhone"></span></p>
            <p><strong>Contraseña:</strong> <span id="profilePassword"></span></p>
            <p><strong>Dirección IP:</strong> <span id="profileIp"></span></p>
            <p><strong>Ubicación:</strong> <span id="profileLocation"></span></p>
            <p><strong>Última Hora de Sesión:</strong> <span id="profileLastLogin"></span></p>
          
            <button id="requestLoanBtn">Solicitar Préstamo</button>

            <!-- solicitud cantidad de $$ -->
            <div id="loanRequestFormContainer" class="hidden">
                <label for="loanAmount">Cantidad:</label>
                <input type="text" id="loanAmount" value="500.00" placeholder="$0.00">
                <p id="loanRequestStatus"></p>
                <label for="termAmount">Pazos</label>
                <select id="termAmount">
                    <option value="1">1 plazo, 1 Semana</option>
                    <option value="2">2 plazos, 2 Semanas</option>
                    <option value="3">3 plazos, 3 Semanas</option>
                    <option value="4">4 plazos, 4 semanas</option>
                    <option value="5">5 plazos, 5 semanas</option>
                    <option value="6">6 plazos, 6 semanas</option>
                    <option value="7">7 plazos, 7 semanas</option>
                    <option value="8">8 plazos, 8 semanas</option>
                    <option value="9">9 plazos, 9 semanas</option>
                    <option value="10">10 plazos, 10 semanas</option>
                    <option value="11">11 plazos, 11 semanas</option>
                    <option value="12">12 plazos, 12 semanas</option>
                </select>

                <button id="submitLoanRequest">Enviar Solicitud</button>
            </div>


            <h3>Solicitudes Pendientes</h3>
            <ul id="loanRequestsList"></ul>
            <h3>Préstamos Aprobados</h3>
            <ul id="approvedRequestsList" class="approved-list"></ul>
            <button id="logoutBtn">Cerrar Sesión</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getDatabase, ref, set, get, push, onValue, update } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCTGTslJDeB8shPTz2EUW6xnpgIKMSkplE",
            authDomain: "avocoin-c672b.firebaseapp.com",
            databaseURL: "https://avocoin-c672b-default-rtdb.firebaseio.com",
            projectId: "avocoin-c672b",
            storageBucket: "avocoin-c672b.appspot.com",
            messagingSenderId: "735532990633",
            appId: "1:735532990633:web:5c3e906b84e48936fbe9b8",
            measurementId: "G-Q0TJQC1RE7"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const storage = getStorage(app);

        // Mostrar formulario de registro y ocultar formulario de inicio de sesión
        document.getElementById('showRegisterForm').addEventListener('click', () => {
            document.getElementById('loginFormContainer').classList.add('hidden');
            document.getElementById('registerFormContainer').classList.remove('hidden');
        });

        // Volver al formulario de inicio de sesión
        document.getElementById('backToLogin').addEventListener('click', () => {
            document.getElementById('registerFormContainer').classList.add('hidden');
            document.getElementById('loginFormContainer').classList.remove('hidden');
        });

        // Función para obtener la IP del usuario
        async function getUserIp() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.error('Error al obtener la IP:', error);
                return 'IP no disponible';
            }
        }

        // Función para obtener la ubicación del usuario
        function getUserLocation() {
            if (navigator.geolocation) {
                return new Promise((resolve) => {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const { latitude, longitude } = position.coords;
                            resolve(`Latitud: ${latitude}, Longitud: ${longitude}`);
                        },
                        (error) => {
                            console.error('Error al obtener la ubicación:', error);
                            resolve('Ubicación no disponible');
                        }
                    );
                });
            } else {
                return Promise.resolve('Geolocalización no soportada');
            }
        }

        // Manejo de inicio de sesión
        document.getElementById('loginForm').addEventListener('submit', async (event) => {
            event.preventDefault();
            const phone = document.getElementById('phone').value;
            const password = document.getElementById('password').value;

            // Verificar credenciales
            const userRef = ref(database, 'users/' + phone);
            const snapshot = await get(userRef);

            if (snapshot.exists() && snapshot.val().password === password) {
                // Autenticación exitosa
                document.getElementById('loginFormContainer').classList.add('hidden');
                document.getElementById('profileContainer').classList.remove('hidden');

                // Mostrar información del perfil
                document.getElementById('profileName').textContent = snapshot.val().name;
                document.getElementById('profilePhone').textContent = phone;
                document.getElementById('profilePassword').textContent = password;

                // Obtener IP y ubicación
                const ip = await getUserIp();
                document.getElementById('profileIp').textContent = ip;

                const location = await getUserLocation();
                document.getElementById('profileLocation').textContent = location;

                // Registrar la última hora de sesión
                const lastLogin = new Date().toISOString();
                await update(userRef, { lastLogin });

                document.getElementById('profileLastLogin').textContent = lastLogin;

    
            } else {
                alert('Número de teléfono o contraseña incorrectos.');
            }
        });








          // Cargar solicitudes y aprobaciones
          function loadRequests(phone) {
            const loanRequestsRef = ref(database, 'users/' + phone + '/loanRequests');
            onValue(loanRequestsRef, (snapshot) => {
                const requestsList = document.getElementById('loanRequestsList');
                const approvedRequestsList = document.getElementById('approvedRequestsList');
                const totalApprovedAmount = document.getElementById('totalApprovedAmount');
                let totalApproved = 0;

                requestsList.innerHTML = '';
                approvedRequestsList.innerHTML = '';

                snapshot.forEach((childSnapshot) => {
                    const request = childSnapshot.val();
                    const status = request.status || 'pendiente';
                    const amount = request.amount;

                    const li = document.createElement('li');
                    li.className = getStatusClass(status);
                    li.innerHTML = `
                        Monto: ${amount} (Solicitado el ${new Date(request.timestamp).toLocaleString()}) - Estado: ${getStatusText(status)}
                        <div class="status-buttons">
                            <button onclick="updateRequestStatus('${phone}', '${childSnapshot.key}', 'aceptado')">Aceptar</button>
                            <button onclick="updateRequestStatus('${phone}', '${childSnapshot.key}', 'cancelado')">Cancelar</button>
                        </div>
                    `;
                    requestsList.appendChild(li);

                    if (status === 'aceptado') {
                        const approvedLi = document.createElement('li');
                        approvedLi.className = 'status-aprobado';
                        approvedLi.textContent = `Monto Aprobado: ${amount} (Solicitado el ${new Date(request.timestamp).toLocaleString()})`;
                        approvedRequestsList.appendChild(approvedLi);

                        // Sumar al total aprobado
                        totalApproved += amount;
                    }
                });

                // Actualizar el total aprobado
                totalApprovedAmount.textContent = `$${totalApproved.toFixed(2)}`;
            });
        }

        // Función para actualizar el estado de una solicitud
        window.updateRequestStatus = (phone, requestId, status) => {
            const requestRef = ref(database, 'users/' + phone + '/loanRequests/' + requestId);
            update(requestRef, { status })
                .then(() => {
                    alert(`Préstamo ${status === 'aceptado' ? 'aceptado' : 'cancelado'} exitosamente.`);
                    loadRequests(phone);
                })
                .catch((error) => {
                    alert('Error al actualizar el estado: ' + error.message);
                });
        };

        function getStatusClass(status) {
            if (status === 'aceptado') {
                return 'status-aprobado';
            } else if (status === 'cancelado') {
                return 'status-cancelado';
            }
            return 'status-pendiente';
        }

        function getStatusText(status) {
            if (status === 'aceptado') {
                return 'Aprobado';
            } else if (status === 'cancelado') {
                return 'Cancelado';
            }
            return 'Pendiente';
        }

        // Solicitar un préstamo
        document.getElementById('requestLoanBtn').addEventListener('click', () => {
            document.getElementById('loanRequestFormContainer').classList.remove('hidden');
        });

        // Enviar solicitud de préstamo
        document.getElementById('submitLoanRequest').addEventListener('click', (e) => {
            e.preventDefault();
            const loanAmount = parseFloat(document.getElementById('loanAmount').value);
            const userPhone = document.getElementById('profilePhone').textContent;

            if (!isNaN(loanAmount) && loanAmount > 0) {
                const loanRequestRef = ref(database, 'users/' + userPhone + '/loanRequests/' + Date.now());

                set(loanRequestRef, {
                    amount: loanAmount,
                    timestamp: new Date().toISOString(),
                    status: 'pendiente'
                })
                .then(() => {
                    document.getElementById('loanRequestFormContainer').classList.add('hidden');
                    document.getElementById('loanRequestStatus').textContent = '¡Solicitud de préstamo enviada, pendiente de aceptación!';
                    document.getElementById('loanAmount').value = '';

                    loadRequests(userPhone);
                })
                .catch((error) => {
                    document.getElementById('loanRequestStatus').textContent = 'Error al enviar la solicitud: ' + error.message;
                });
            } else {
                alert('Por favor, ingrese una cantidad válida.');
            }
        });





        // Cierre de sesión
        document.getElementById('logoutBtn').addEventListener('click', () => {
            document.getElementById('profileContainer').classList.add('hidden');
            document.getElementById('loginFormContainer').classList.remove('hidden');
        });





        // Manejar vista previa de imágenes
        function handleFileSelect(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById(event.target.dataset.previewId);
                preview.src = e.target.result;
                preview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        document.getElementById('frontPhoto').addEventListener('change', (event) => handleFileSelect({ target: { files: event.target.files, dataset: { previewId: 'frontImagePreview' } } }));
        document.getElementById('backPhoto').addEventListener('change', (event) => handleFileSelect({ target: { files: event.target.files, dataset: { previewId: 'backImagePreview' } } }));
        document.getElementById('selfie').addEventListener('change', (event) => handleFileSelect({ target: { files: event.target.files, dataset: { previewId: 'selfieImagePreview' } } }));
    


    // Manejo del registro de usuario
document.getElementById('registerForm').addEventListener('submit', async (event) => {
    event.preventDefault(); // Prevenir envío del formulario
    
    const name = document.getElementById('regName').value;
    const phone = document.getElementById('regPhone').value;
    const password = document.getElementById('regPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const email = document.getElementById('email').value;
    const age = document.getElementById('age').value;
    const address = document.getElementById('address').value;


     // Verificar que las contraseñas coincidan
    if (password !== confirmPassword) {
        alert('Las contraseñas no coinciden.');
        return; // Salir de la función si las contraseñas no coinciden
    }

  

    // Subir fotos
    const frontPhoto = document.getElementById('frontPhoto').files[0];
    const backPhoto = document.getElementById('backPhoto').files[0];
    const selfie = document.getElementById('selfie').files[0];

    if (frontPhoto && backPhoto && selfie) {
        try {
            // Subir fotos a Firebase Storage y obtener URLs
            const frontPhotoRef = storageRef(storage, `photos/front_${phone}`);
            const backPhotoRef = storageRef(storage, `photos/back_${phone}`);
            const selfieRef = storageRef(storage, `photos/selfie_${phone}`);

            await uploadBytes(frontPhotoRef, frontPhoto);
            await uploadBytes(backPhotoRef, backPhoto);
            await uploadBytes(selfieRef, selfie);

            const frontPhotoURL = await getDownloadURL(frontPhotoRef);
            const backPhotoURL = await getDownloadURL(backPhotoRef);
            const selfieURL = await getDownloadURL(selfieRef);

            // Guardar datos del usuario en la base de datos
            const userRef = ref(database, 'users/' + phone);
            await set(userRef, {
                name,
                phone,
                password,
                email,
                age,
                address,
                frontPhoto: frontPhotoURL,
                backPhoto: backPhotoURL,
                selfie: selfieURL
            });

            alert('Usuario registrado exitosamente.');

            // Recargar la página después de que el usuario se registre
            window.location.reload();

        } catch (error) {
            console.error('Error al subir fotos:', error);
            alert('Error al registrar el usuario. Inténtalo de nuevo.');
        }
    } else {
        alert('Por favor, sube todas las fotos requeridas.');
    }
});

// Contador de referencias
let contadorReferencias = 0;

// Referencia al contenedor de referencias
const contenedorReferencias = document.getElementById('contenedor-referencias');

// Evento click para agregar referencia
document.getElementById('agregar-referencia').addEventListener('click', () => {
    // Incrementar contador de referencias
    contadorReferencias++;

    // Crear nueva referencia
    const referencia = document.createElement('div');
    referencia.className = 'referencia';

    // HTML para la nueva referencia
    referencia.innerHTML = `
        <input type="text" id="nombre-referencia-${contadorReferencias}" placeholder="Nombre">
        <input type="tel" id="telefono-referencia-${contadorReferencias}" placeholder="Teléfono">
        <input type="text" id="Parentesco-referencia-${contadorReferencias}" placeholder="Parentesco de referencia">
        <!-- Botón para agregar contacto 
        <button type="button" id="agregar-contacto-general">Agregar contacto</button> -->

    `;

    // Agregar referencia al contenedor
    contenedorReferencias.appendChild(referencia);
});

// Evento click para agregar contacto usando el botón específico
document.getElementById('agregar-contacto-general').addEventListener('click', () => {
    // Iterar sobre cada referencia en el contenedor
    const referencias = document.querySelectorAll('#contenedor-referencias .referencia');

    referencias.forEach(referencia => {
        // Obtener los valores de nombre y teléfono
        const nombre = referencia.querySelector('input[type="text"]').value;
        const telefono = referencia.querySelector('input[type="tel"]').value;

        // Verificar que se hayan ingresado valores
        if (nombre && telefono) {
            // Llamar función para agregar contacto
            agregarContacto(nombre, telefono);

            // Actualizar HTML de la referencia
            referencia.innerHTML = `
                <span class="nombre">${nombre}</span>
                <span class="telefono">${telefono}</span>
            `;
        }
    });
});


/*
// Función para agregar contacto (puedes modificar esta función según tus necesidades)
function agregarContacto(nombre, telefono) {
    // Implementar la lógica para agregar el contacto
    console.log(`Contacto agregado: ${nombre}, ${telefono}`);
} */


    </script>
</body>
</html>

